colorNames = [
  { text: 'Alice Blue', id: 'F0F8FF' },
  { text: 'Antique White', id: 'FAEBD7' },
  { text: 'Aqua', id: '00FFFF' },
  { text: 'Aquamarine', id: '7FFFD4' },
  { text: 'Azure', id: 'F0FFFF' },
  { text: 'Beige', id: 'F5F5DC' },
  { text: 'Bisque', id: 'FFE4C4' },
  { text: 'Black', id: '000000' },
  { text: 'Blanched Almond', id: 'FFEBCD' },
  { text: 'Blue', id: '0000FF' },
  { text: 'Blue Violet', id: '8A2BE2' },
  { text: 'Brown', id: 'A52A2A' },
  { text: 'Burly Wood', id: 'DEB887' },
  { text: 'Cadet Blue', id: '5F9EA0' },
  { text: 'Chartreuse', id: '7FFF00' },
  { text: 'Chocolate', id: 'D2691E' },
  { text: 'Coral', id: 'FF7F50' },
  { text: 'Cornflower Blue', id: '6495ED' },
  { text: 'Cornsilk', id: 'FFF8DC' },
  { text: 'Crimson', id: 'DC143C' },
  { text: 'Cyan', id: '00FFFF' },
  { text: 'Dark Blue', id: '00008B' },
  { text: 'Dark Cyan', id: '008B8B' },
  { text: 'Dark Golden Rod', id: 'B8860B' },
  { text: 'Dark Gray', id: 'A9A9A9' },
  { text: 'Dark Green', id: '006400' },
  { text: 'Dark Khaki', id: 'BDB76B' },
  { text: 'Dark Magenta', id: '8B008B' },
  { text: 'Dark Olive Green', id: '556B2F' },
  { text: 'Dark Orange', id: 'FF8C00' },
  { text: 'Dark Orchid', id: '9932CC' },
  { text: 'Dark Red', id: '8B0000' },
  { text: 'Dark Salmon', id: 'E9967A' },
  { text: 'Dark Sea Green', id: '8FBC8F' },
  { text: 'Dark Slate Blue', id: '483D8B' },
  { text: 'Dark Slate Gray', id: '2F4F4F' },
  { text: 'Dark Turquoise', id: '00CED1' },
  { text: 'Dark Violet', id: '9400D3' },
  { text: 'Deep Pink', id: 'FF1493' },
  { text: 'Deep Sky Blue', id: '00BFFF' },
  { text: 'Dim Gray', id: '696969' },
  { text: 'Dodger Blue', id: '1E90FF' },
  { text: 'Fire Brick', id: 'B22222' },
  { text: 'Floral White', id: 'FFFAF0' },
  { text: 'Forest Green', id: '228B22' },
  { text: 'Fuchsia', id: 'FF00FF' },
  { text: 'Gainsboro', id: 'DCDCDC' },
  { text: 'Ghost White', id: 'F8F8FF' },
  { text: 'Gold', id: 'FFD700' },
  { text: 'Golden Rod', id: 'DAA520' },
  { text: 'Gray', id: '808080' },
  { text: 'Green', id: '008000' },
  { text: 'Green Yellow', id: 'ADFF2F' },
  { text: 'Honey Dew', id: 'F0FFF0' },
  { text: 'Hot Pink', id: 'FF69B4' },
  { text: 'Indian Red', id: 'CD5C5C' },
  { text: 'Indigo', id: '4B0082' },
  { text: 'Ivory', id: 'FFFFF0' },
  { text: 'Khaki', id: 'F0E68C' },
  { text: 'Lavender', id: 'E6E6FA' },
  { text: 'Lavender Blush', id: 'FFF0F5' },
  { text: 'Lawn Green', id: '7CFC00' },
  { text: 'Lemon Chiffon', id: 'FFFACD' },
  { text: 'Light Blue', id: 'ADD8E6' },
  { text: 'Light Coral', id: 'F08080' },
  { text: 'Light Cyan', id: 'E0FFFF' },
  { text: 'Light Golden Rod Yellow', id: 'FAFAD2' },
  { text: 'Light Gray', id: 'D3D3D3' },
  { text: 'Light Green', id: '90EE90' },
  { text: 'Light Pink', id: 'FFB6C1' },
  { text: 'Light Salmon', id: 'FFA07A' },
  { text: 'Light Sea Green', id: '20B2AA' },
  { text: 'Light Sky Blue', id: '87CEFA' },
  { text: 'Light Slate Gray', id: '778899' },
  { text: 'Light Steel Blue', id: 'B0C4DE' },
  { text: 'Light Yellow', id: 'FFFFE0' },
  { text: 'Lime', id: '00FF00' },
  { text: 'Lime Green', id: '32CD32' },
  { text: 'Linen', id: 'FAF0E6' },
  { text: 'Magenta', id: 'FF00FF' },
  { text: 'Maroon', id: '800000' },
  { text: 'Medium Aqua Marine', id: '66CDAA' },
  { text: 'Medium Blue', id: '0000CD' },
  { text: 'Medium Orchid', id: 'BA55D3' },
  { text: 'Medium Purple', id: '9370DB' },
  { text: 'Medium Sea Green', id: '3CB371' },
  { text: 'Medium Slate Blue', id: '7B68EE' },
  { text: 'Medium Spring Green', id: '00FA9A' },
  { text: 'Medium Turquoise', id: '48D1CC' },
  { text: 'Medium Violet Red', id: 'C71585' },
  { text: 'Midnight Blue', id: '191970' },
  { text: 'Mint Cream', id: 'F5FFFA' },
  { text: 'Misty Rose', id: 'FFE4E1' },
  { text: 'Moccasin', id: 'FFE4B5' },
  { text: 'Navajo White', id: 'FFDEAD' },
  { text: 'Navy', id: '000080' },
  { text: 'Old Lace', id: 'FDF5E6' },
  { text: 'Olive', id: '808000' },
  { text: 'Olive Drab', id: '6B8E23' },
  { text: 'Orange', id: 'FFA500' },
  { text: 'Orange Red', id: 'FF4500' },
  { text: 'Orchid', id: 'DA70D6' },
  { text: 'Pale Golden Rod', id: 'EEE8AA' },
  { text: 'Pale Green', id: '98FB98' },
  { text: 'Pale Turquoise', id: 'AFEEEE' },
  { text: 'Pale Violet Red', id: 'DB7093' },
  { text: 'Papaya Whip', id: 'FFEFD5' },
  { text: 'Peach Puff', id: 'FFDAB9' },
  { text: 'Peru', id: 'CD853F' },
  { text: 'Pink', id: 'FFC0CB' },
  { text: 'Plum', id: 'DDA0DD' },
  { text: 'Powder Blue', id: 'B0E0E6' },
  { text: 'Purple', id: '800080' },
  { text: 'Red', id: 'FF0000' },
  { text: 'Rosy Brown', id: 'BC8F8F' },
  { text: 'Royal Blue', id: '4169E1' },
  { text: 'Saddle Brown', id: '8B4513' },
  { text: 'Salmon', id: 'FA8072' },
  { text: 'Sandy Brown', id: 'F4A460' },
  { text: 'Sea Green', id: '2E8B57' },
  { text: 'Sea Shell', id: 'FFF5EE' },
  { text: 'Sienna', id: 'A0522D' },
  { text: 'Silver', id: 'C0C0C0' },
  { text: 'Sky Blue', id: '87CEEB' },
  { text: 'Slate Blue', id: '6A5ACD' },
  { text: 'Slate Gray', id: '708090' },
  { text: 'Snow', id: 'FFFAFA' },
  { text: 'Spring Green', id: '00FF7F' },
  { text: 'Steel Blue', id: '4682B4' },
  { text: 'Tan', id: 'D2B48C' },
  { text: 'Teal', id: '008080' },
  { text: 'Thistle', id: 'D8BFD8' },
  { text: 'Tomato', id: 'FF6347' },
  { text: 'Turquoise', id: '40E0D0' },
  { text: 'Violet', id: 'EE82EE' },
  { text: 'Wheat', id: 'F5DEB3' },
  { text: 'White', id: 'FFFFFF' },
  { text: 'White Smoke', id: 'F5F5F5' },
  { text: 'Yellow', id: 'FFFF00' },
  { text: 'Yellow Green', id: '9ACD32' },
]

$.widget "custom.colorTags",
  _create: ()->
    formatColorItem = (item)->
      "<div class='search-color-item' style='background-color: ##{item.id};'></div> #{item.text}"
    isColorHex = (text)->
      /^[0-9A-F]{6}$/i.test(text)

    unless @element.data('select2')
      @element.select2({
        tags: ->
          $.map(colorNames.concat(colorTableValues), (color)->
            { id: color.id, text: color.text}
        )
        formatSelection: (item, container)->
          $colorName = $('<span></span>')
          $colorName.text(item.text)
          container.append($colorName)

          container.css(width: '100%', height: '100%')
          coloredBlock = "<div class='fav-color' style='background-color: ##{item.id};'></div>"
          container.append(coloredBlock)

          $closeGlyph = $('<i></i>').addClass('glyphicon glyphic-r glyphicon-remove pull-right')
          container.addClass('selected-color-item')
          container.next('.select2-search-choice-close').append($closeGlyph)
          null

        formatResult: formatColorItem
        sortResults: (results, container, query) ->
          return results unless query.term
          results.sort((a, b) ->
            return 1 if a.text.length > b.text.length
            return -1 if a.text.length < b.text.length
            0
          )
      }).on('select2-selecting', (e)->
        e.preventDefault() unless isColorHex(e.val)
      ).on('change');

    @element.select2('readonly', true) if @options.readonly

class @ColorsEditor

  constructor: (options)->
    @colorButtonSelector = '.color-cell'
    @$colorTags = options.$colorTags
    @$colorsTable = options.$colorsTable
    @$colorInput = options.$colorInput

  colorsLimit: 12

  canAdd: ->
    @currentColors().length < @colorsLimit

  add: (color)->
    colors = @currentColors()
    @setCurrentColors(colors.concat(color))

  remove: (color)->
    newColors = $.grep(@currentColors(), (selectedColor, index)->
      selectedColor.id != color.id
    )
    @setCurrentColors(newColors)

  deselectCell: ($button)->
    $button.removeClass('selected')
    $button.find('.check').remove()

  selectCell: ($button)->
    $button.addClass('selected')
    $button.append(@checkMark().clone().show())

  initColorsTable: ->
    @$colorsTable.find(@colorButtonSelector).click (event)=>
      $button = $(event.target).closest(@colorButtonSelector)
      selected = !$button.hasClass('selected')
      color = @selectedColor($button)
      if selected
        if @canAdd()
          @selectCell($button)
          @add(color)
      else
        @deselectCell($button)
        @remove(color)

    for color in @currentColors()
      $button = @$colorsTable.find(@colorButtonSelector).filter("[data-id='#{ color.id }']")
      @selectCell($button)

  currentColors: ->
    @$colorTags.select2('data')

  setCurrentColors: (newColors)->
    @$colorTags.select2('data', newColors)

  checkMark: ->
    @$colorsTable.find('> .check')

  selectedColor: ($button)->
    { id: $button.data('id'), text: $button.data('text') }

  initSelectedColors: ->
    @$colorTags.colorTags
      readonly: false
    @$colorTags.select2('container').find('.select2-search-field').hide()
    @$colorTags.find('.select2-search, .select2-focusser').remove();
    @$colorTags.on 'select2-opening', (event)->
      event.preventDefault()
    @$colorTags.on 'select2-removed', (event)=>
      $colorButton = @$colorsTable.find(@colorButtonSelector).filter("[data-id='#{ event.choice.id }']")
      @deselectCell($colorButton)

  initColorNameInput: ->
    $colorNameInput = @$colorInput.colorTags({ readonly: false })
    $colorNameInput.on 'select2-selecting', (event)=>
      @add(event.choice) if @canAdd()
      event.preventDefault()
      $(event.target).select2('close')

  init: ->
    @initSelectedColors()
    @initColorNameInput()
    @initColorsTable()
